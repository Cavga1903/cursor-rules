---
alwaysApply: true
---

# Testing Rules - Test Best Practices

> âš ï¸ **Ã–NEMLÄ°:** Bu dosya her zaman uygulanÄ±r. Test yazarken bu kurallara uyun.

---

## ğŸ¯ Test Stratejisi

### 1. Test Piramidi

```
        /\
       /  \      E2E Tests (Az)
      /____\
     /      \    Integration Tests (Orta)
    /________\
   /          \  Unit Tests (Ã‡ok)
  /____________\
```

**Ã–ncelik SÄ±rasÄ±:**
1. **Unit Tests** - Fonksiyonlar, utility functions, pure functions
2. **Integration Tests** - Component interactions, API calls, database
3. **E2E Tests** - Critical user flows (login, checkout, vb.)

---

### 2. Test Coverage Hedefleri

- **Critical Path:** %100 coverage (authentication, payment, stock)
- **Business Logic:** %80+ coverage
- **UI Components:** %60+ coverage
- **Overall:** %60+ coverage

---

## ğŸ§ª Unit Testing

### 1. Test Structure (AAA Pattern)

**âœ… DoÄŸru:**
```typescript
describe("calculateTotal", () => {
  it("should return sum of all item prices", () => {
    // Arrange
    const items = [
      { id: "1", price: 100 },
      { id: "2", price: 200 },
      { id: "3", price: 300 },
    ];
    
    // Act
    const result = calculateTotal(items);
    
    // Assert
    expect(result).toBe(600);
  });
});
```

---

### 2. Test Naming

**âœ… DoÄŸru:**
```typescript
describe("UserService", () => {
  describe("login", () => {
    it("should return user when credentials are valid", () => {});
    it("should throw error when credentials are invalid", () => {});
    it("should throw error when user is locked", () => {});
  });
});
```

**âŒ YanlÄ±ÅŸ:**
```typescript
it("test1", () => {});
it("should work", () => {});
```

---

### 3. Test Isolation

**âŒ YanlÄ±ÅŸ (Shared state):**
```typescript
let user: User;

beforeAll(() => {
  user = createUser();  // Shared state
});

it("test 1", () => {
  user.name = "John";  // DiÄŸer testleri etkileyebilir
});
```

**âœ… DoÄŸru (Isolated state):**
```typescript
it("test 1", () => {
  const user = createUser();  // Her test iÃ§in yeni instance
  user.name = "John";
  expect(user.name).toBe("John");
});
```

---

## ğŸ§© Component Testing

### 1. React Testing Library

**âŒ YanlÄ±ÅŸ (Implementation details test):**
```typescript
it("should call handleClick when button is clicked", () => {
  const handleClick = jest.fn();
  const { getByTestId } = render(<Button onClick={handleClick} />);
  
  getByTestId("button").click();  // Implementation detail
  expect(handleClick).toHaveBeenCalled();
});
```

**âœ… DoÄŸru (User behavior test):**
```typescript
it("should submit form when submit button is clicked", () => {
  const onSubmit = jest.fn();
  const { getByRole } = render(<Form onSubmit={onSubmit} />);
  
  // User gibi davran
  fireEvent.change(getByRole("textbox", { name: /email/i }), {
    target: { value: "test@example.com" },
  });
  fireEvent.click(getByRole("button", { name: /submit/i }));
  
  expect(onSubmit).toHaveBeenCalledWith({
    email: "test@example.com",
  });
});
```

---

### 2. Query Priority (React Testing Library)

**Ã–ncelik SÄ±rasÄ±:**
1. `getByRole` - Accessibility iÃ§in en iyi
2. `getByLabelText` - Form elements iÃ§in
3. `getByPlaceholderText` - Input fields iÃ§in
4. `getByText` - Text content iÃ§in
5. `getByTestId` - Son Ã§are (implementation detail)

**âœ… DoÄŸru:**
```typescript
const { getByRole } = render(<Button>Submit</Button>);
const button = getByRole("button", { name: /submit/i });
```

**âŒ YanlÄ±ÅŸ:**
```typescript
const { getByTestId } = render(<Button data-testid="submit-btn">Submit</Button>);
const button = getByTestId("submit-btn");  // Implementation detail
```

---

### 3. Async Testing

**âŒ YanlÄ±ÅŸ (setTimeout):**
```typescript
it("should load data", async () => {
  loadData();
  setTimeout(() => {
    expect(data).toBeDefined();
  }, 1000);
});
```

**âœ… DoÄŸru (waitFor):**
```typescript
it("should load data", async () => {
  loadData();
  await waitFor(() => {
    expect(data).toBeDefined();
  });
});
```

**Veya findBy queries:**
```typescript
it("should display user name", async () => {
  render(<UserProfile userId="123" />);
  const name = await screen.findByText("John Doe");
  expect(name).toBeInTheDocument();
});
```

---

## ğŸ”— Integration Testing

### 1. API Testing

**âœ… DoÄŸru (Mock API):**
```typescript
import { vi } from "vitest";
import { invoke } from "@tauri-apps/api/tauri";

vi.mock("@tauri-apps/api/tauri");

it("should fetch products", async () => {
  const mockProducts = [
    { id: "1", name: "Product 1" },
    { id: "2", name: "Product 2" },
  ];
  
  (invoke as any).mockResolvedValue(mockProducts);
  
  const products = await fetchProducts();
  
  expect(products).toEqual(mockProducts);
  expect(invoke).toHaveBeenCalledWith("get_products");
});
```

---

### 2. Database Testing

**âœ… DoÄŸru (Test database):**
```typescript
import { createTestDatabase } from "./test-utils";

it("should create product", async () => {
  const db = await createTestDatabase();
  
  const product = await createProduct(db, {
    name: "Test Product",
    price: 1000,
  });
  
  expect(product.id).toBeDefined();
  expect(product.name).toBe("Test Product");
  
  await db.close();
});
```

---

## ğŸ­ Mocking & Stubbing

### 1. Function Mocking

**âœ… DoÄŸru:**
```typescript
import { vi } from "vitest";

const mockFetch = vi.fn();
global.fetch = mockFetch;

it("should fetch data", async () => {
  mockFetch.mockResolvedValue({
    ok: true,
    json: async () => ({ data: "test" }),
  });
  
  const result = await fetchData();
  
  expect(result).toEqual({ data: "test" });
  expect(mockFetch).toHaveBeenCalledWith("/api/data");
});
```

---

### 2. Module Mocking

**âœ… DoÄŸru:**
```typescript
import { vi } from "vitest";

vi.mock("./api", () => ({
  fetchUser: vi.fn().mockResolvedValue({ id: "1", name: "John" }),
}));

it("should use mocked API", async () => {
  const user = await fetchUser("1");
  expect(user.name).toBe("John");
});
```

---

## ğŸ“Š Test Coverage

### 1. Coverage Thresholds

**vitest.config.ts:**
```typescript
export default defineConfig({
  test: {
    coverage: {
      provider: "v8",
      reporter: ["text", "json", "html"],
      thresholds: {
        lines: 60,
        functions: 60,
        branches: 60,
        statements: 60,
      },
      exclude: [
        "node_modules/",
        "**/*.test.ts",
        "**/*.spec.ts",
      ],
    },
  },
});
```

---

### 2. Critical Path Coverage

**âœ… DoÄŸru (Critical path %100):**
```typescript
// Critical: Authentication
describe("Authentication", () => {
  it("should login with valid credentials", () => {});
  it("should reject invalid credentials", () => {});
  it("should handle rate limiting", () => {});
  it("should expire session after timeout", () => {});
  // %100 coverage hedefi
});
```

---

## ğŸš« Anti-Patterns

### 1. Test Implementation Details

**âŒ YanlÄ±ÅŸ:**
```typescript
it("should set state", () => {
  const component = render(<Component />);
  expect(component.state.count).toBe(0);  // Implementation detail
});
```

**âœ… DoÄŸru:**
```typescript
it("should display initial count", () => {
  render(<Component />);
  expect(screen.getByText("Count: 0")).toBeInTheDocument();
});
```

---

### 2. Over-Mocking

**âŒ YanlÄ±ÅŸ:**
```typescript
const mockAdd = vi.fn();
const mockSubtract = vi.fn();
const mockMultiply = vi.fn();
// Her ÅŸeyi mock'ladÄ±k - gerÃ§ek logic test edilmiyor
```

**âœ… DoÄŸru:**
```typescript
// Sadece external dependencies'i mock'la
vi.mock("./api");
// Internal logic'i test et
```

---

### 3. Flaky Tests

**âŒ YanlÄ±ÅŸ (Timing-dependent):**
```typescript
it("should update after 1 second", () => {
  updateData();
  setTimeout(() => {
    expect(data).toBeUpdated();
  }, 1000);
});
```

**âœ… DoÄŸru (Deterministic):**
```typescript
it("should update data", async () => {
  updateData();
  await waitFor(() => {
    expect(data).toBeUpdated();
  });
});
```

---

## ğŸ“‹ Test Checklist

### Unit Tests
- [ ] AAA pattern kullanÄ±ldÄ± mÄ±? (Arrange, Act, Assert)
- [ ] Test isolation var mÄ±? (Shared state yok)
- [ ] Test naming aÃ§Ä±klayÄ±cÄ± mÄ±?
- [ ] Edge cases test edildi mi?

### Component Tests
- [ ] React Testing Library kullanÄ±ldÄ± mÄ±?
- [ ] Query priority doÄŸru mu? (getByRole > getByTestId)
- [ ] User behavior test edildi mi? (Implementation details deÄŸil)
- [ ] Async operations doÄŸru handle edildi mi?

### Integration Tests
- [ ] API calls mock'landÄ± mÄ±?
- [ ] Database operations test edildi mi?
- [ ] Component interactions test edildi mi?

### Coverage
- [ ] Critical path %100 coverage var mÄ±?
- [ ] Overall coverage %60+ var mÄ±?
- [ ] Coverage thresholds tanÄ±mlÄ± mÄ±?

---

## ğŸ”— Referanslar

- [React Testing Library](https://testing-library.com/react)
- [Vitest Documentation](https://vitest.dev/)
- [Testing Best Practices](https://kentcdodds.com/blog/common-mistakes-with-react-testing-library)

---

**Son GÃ¼ncelleme:** 2026-01-19  
**Versiyon:** 1.0.0
